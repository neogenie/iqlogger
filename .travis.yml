os: linux
dist: xenial
language: shell

services:
  - docker

jobs:
  include:
    - env:
        - TAG=ubuntu16
        - ARCH=amd64
        - UBUNTU=xenial
    - env:
        - TAG=ubuntu18
        - ARCH=amd64
        - UBUNTU=bionic

script:
  - export VERSION=`cat ./version`
  - docker build -t builder --build-arg VERSION="$VERSION" --build-arg TAG="$TAG" --build-arg ARCH="$ARCH" --build-arg UBUNTU="$UBUNTU" --build-arg CI_PIPELINE_ID="$TRAVIS_BUILD_NUMBER" --build-arg CI_COMMIT_REF_NAME="$TRAVIS_BRANCH" --build-arg CI_COMMIT_SHA="$TRAVIS_COMMIT" --build-arg CI_COMMIT_MESSAGE="$TRAVIS_COMMIT_MESSAGE" --build-arg CI_USER="$USER" -f .build/Dockerfile .
  - docker create --name builder builder
  - mkdir -p ${TRAVIS_BUILD_DIR}/build
  - docker cp builder:/iqlogger/iqlogger ${TRAVIS_BUILD_DIR}/build/
  - docker cp builder:/iqlogger/.build_deb/${TAG}/iqlogger_$VERSION-${UBUNTU}_$ARCH.deb ${TRAVIS_BUILD_DIR}/build/
  - docker rm builder
  - ls -alh ${TRAVIS_BUILD_DIR}/build
  - if [[ "$TAG" == "ubuntu18" ]]; then
      echo "$DOCKER_PASSWORD" | docker login -u "$DOCKER_USERNAME" --password-stdin;
      cp ${TRAVIS_BUILD_DIR}/build/iqlogger .docker/usr/local/bin/;
      docker build -t neogenie/iqlogger:$VERSION .docker;
      docker push neogenie/iqlogger:$VERSION;
      docker tag neogenie/iqlogger:$VERSION neogenie/iqlogger:latest;
      docker push neogenie/iqlogger:latest;
    fi

deploy:
  provider: releases
  api_key: "$GITHUB_TOKEN"
  file_glob: true
  file: ${TRAVIS_BUILD_DIR}/build/*.deb
  skip_cleanup: true
  draft: true
#  on:
#    tags: true